<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後台庫存管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設置全局字體和背景 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* 專門針對可編輯的數量文字設置樣式 */
        .editable-quantity {
            transition: background-color 0.2s;
        }
        .editable-quantity:hover {
            background-color: #e5e7eb; /* 淺灰色背景提示可點擊 */
            cursor: pointer;
        }
        /* 隱藏 Chrome/Firefox 的數字輸入框箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-900">庫存管理後台</h1>
            <p class="text-sm text-gray-500 mt-1">即時更新庫存數量 | <span id="lastUpdated">正在載入...</span></p>
            <!-- 部署資訊，供調試使用 -->
            <p class="text-xs text-gray-400 mt-2">當前 Worker 版本。請確保 Apps Script 部署成功。</p>
        </header>

        <!-- Tab 選項 -->
        <div id="tabs" class="flex bg-white shadow-lg rounded-t-lg overflow-hidden mb-8">
            <button 
                id="tab-Breakfast" 
                data-sheet="Breakfast" 
                class="sheet-tab flex-1 py-4 text-center text-xl font-bold transition duration-150 border-b-4 border-indigo-600 text-indigo-600 bg-indigo-50/50">
                早餐
            </button>
            <button 
                id="tab-Lunch" 
                data-sheet="Lunch" 
                class="sheet-tab flex-1 py-4 text-center text-xl font-bold transition duration-150 border-b-4 border-transparent text-gray-600 hover:bg-gray-50">
                午餐
            </button>
        </div>

        <!-- 錯誤與載入指示器 -->
        <div id="loadingIndicator" class="text-center py-20 hidden">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-xl text-indigo-600 font-medium">正在從資料庫中獲取最新資料...</p>
        </div>

        <div id="errorMessage" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-5 rounded-lg shadow-md mb-8" role="alert">
            <p class="font-bold text-lg mb-1">⚠️ 系統錯誤</p>
            <p id="errorDetail" class="text-sm"></p>
        </div>

        <div id="inventoryContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 庫存卡片將插入於此 -->
        </div>

    </div>

    <script>
        // 假設 Worker 路由是 /api/inventory
        const API_ENDPOINT = '/api/inventory';
        let currentSheet = 'Breakfast';

        document.addEventListener('DOMContentLoaded', () => {
            // 監聽 Tab 按鈕
            document.querySelectorAll('.sheet-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const sheetName = e.currentTarget.dataset.sheet;
                    switchTab(sheetName);
                });
            });

            // 初始化載入
            loadInventory(currentSheet);
        });

        // --- 核心功能函數 ---

        /** * 切換 Tab 樣式並重新載入庫存 
         * @param {string} newSheetName 
         */
        function switchTab(newSheetName) {
            if (currentSheet === newSheetName) return;

            // 更新按鈕樣式
            document.querySelectorAll('.sheet-tab').forEach(tab => {
                tab.classList.remove('border-indigo-600', 'text-indigo-600', 'bg-indigo-50/50');
                tab.classList.add('border-transparent', 'text-gray-600', 'hover:bg-gray-50');
            });

            const activeTab = document.getElementById(`tab-${newSheetName}`);
            activeTab.classList.add('border-indigo-600', 'text-indigo-600', 'bg-indigo-50/50');
            activeTab.classList.remove('border-transparent', 'text-gray-600', 'hover:bg-gray-50');

            currentSheet = newSheetName;
            loadInventory(currentSheet);
        }
        
        /**
         * 載入指定工作表的庫存資料
         * @param {string} sheetName 
         */
        async function loadInventory(sheetName) {
            const container = document.getElementById('inventoryContainer');
            const loading = document.getElementById('loadingIndicator');
            const errorDiv = document.getElementById('errorMessage');

            container.innerHTML = '';
            errorDiv.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                // 使用 GET 請求從 Worker 代理獲取資料
                const response = await fetch(`${API_ENDPOINT}?sheetName=${sheetName}`);
                const result = await response.json();

                if (result.error) {
                    displayError(`資料庫回傳錯誤: ${result.message}`);
                    return;
                }
                
                // 成功載入
                renderInventory(result.data, container);
                updateTimestamp(result.updated_at);

            } catch (error) {
                displayError(`連線錯誤或 API 代理失敗: ${error.message}`);
            } finally {
                loading.classList.add('hidden');
            }
        }
        
        /**
         * 渲染庫存卡片到頁面
         * @param {Array<Object>} data 
         * @param {HTMLElement} container 
         */
        function renderInventory(data, container) {
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center col-span-full py-10">此工作表目前沒有庫存品項。</p>`;
                return;
            }

            // **修正 1：移除 item.quantity，讓 changeQuantity 函數自行從 DOM 讀取最新值**
            container.innerHTML = data.map(item => `
                <div id="item-${item.row}" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 transition duration-300 hover:shadow-lg">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">${item.name}</h3>
                    
                    <div class="flex items-center justify-between space-x-4">
                        
                        <!-- 數量顯示/編輯區域 -->
                        <div class="flex-grow flex justify-center items-center h-12">
                            <span 
                                class="text-3xl font-bold text-gray-900 px-4 py-1 rounded-lg editable-quantity"
                                data-name="${item.name}"
                                data-row="${item.row}"
                                data-quantity="${item.quantity}"
                                onclick="toggleEditMode(this)"
                            >
                                ${item.quantity}
                            </span>
                        </div>
                        
                        <!-- 增減按鈕區域 -->
                        <div class="flex space-x-2">
                            <button 
                                class="w-12 h-12 bg-red-500 text-white text-3xl rounded-lg font-bold hover:bg-red-600 active:bg-red-700 transition duration-150 shadow-md"
                                onclick="changeQuantity(${item.row}, -1)">
                                -
                            </button>
                            <button 
                                class="w-12 h-12 bg-green-500 text-white text-3xl rounded-lg font-bold hover:bg-green-600 active:bg-green-700 transition duration-150 shadow-md"
                                onclick="changeQuantity(${item.row}, 1)">
                                +
                            </button>
                        </div>
                    </div>
                    <div id="status-${item.row}" class="text-center text-sm mt-3 h-4"></div>
                </div>
            `).join('');
        }
        
        /**
         * 更新顯示的時間戳記
         * @param {string | null} timestampStr 
         */
        function updateTimestamp(timestampStr) {
            const tsElement = document.getElementById('lastUpdated');
            if (timestampStr) {
                const date = new Date(timestampStr);
                tsElement.textContent = `更新時間: ${date.toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                })}`;
            } else {
                tsElement.textContent = `更新時間: N/A (時間讀取失敗)`;
            }
        }
        
        /**
         * 顯示頂部錯誤訊息
         * @param {string} message 
         */
        function displayError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorDetail = document.getElementById('errorDetail');
            errorDetail.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        /**
         * 顯示單個品項的狀態訊息 (成功/失敗)
         * @param {number} row 
         * @param {string} message 
         * @param {boolean} isSuccess
         */
        function displayItemStatus(row, message, isSuccess) {
            const statusElement = document.getElementById(`status-${row}`);
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = isSuccess ? 'text-green-600 text-sm mt-3 h-4' : 'text-red-600 text-sm mt-3 h-4';
                // 2 秒後清除訊息
                setTimeout(() => {
                    if(statusElement.textContent === message) statusElement.textContent = '';
                }, 2000);
            }
        }


        // --- 互動功能函數 ---

        /**
         * 處理增減按鈕點擊，並從 DOM 讀取最新庫存數量
         * @param {number} row - 要更新的試算表行號
         * @param {number} delta - 增減量 (+1 或 -1)
         * * **修正 2：修改 changeQuantity 函數，讓它動態讀取 dataset.quantity**
         */
        function changeQuantity(row, delta) {
            const quantitySpan = document.querySelector(`.editable-quantity[data-row="${row}"]`);
            if (!quantitySpan) {
                 console.error(`無法找到 Row ${row} 的數量元素。`);
                 return;
            }

            // 從 DOM 元素的 data-quantity 屬性中讀取當前數量
            const currentQuantity = parseInt(quantitySpan.dataset.quantity || '0', 10);
            const newQuantity = Math.max(0, currentQuantity + delta); // 數量不小於 0

            if (newQuantity !== currentQuantity) {
                updateInventory(row, newQuantity);
            }
        }

        /**
         * 切換數量顯示區域為輸入框，以便手動輸入
         * @param {HTMLElement} element 
         */
        function toggleEditMode(element) {
            if (element.querySelector('input')) return; // 已經是輸入模式

            const currentQuantity = parseInt(element.dataset.quantity || '0');

            // 創建輸入框
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentQuantity;
            input.className = 'w-full h-full text-3xl font-bold text-gray-900 text-center border-2 border-indigo-500 rounded-lg p-1 focus:outline-none';
            input.min = '0'; // 確保不會輸入負數

            // 退出編輯模式並恢復文字顯示
            const exitEditMode = (el, quantity) => {
                el.innerHTML = quantity;
                el.dataset.quantity = quantity;
                // 注意：這裡應該移除事件監聽器，但因為它們是定義在 handleBlur/handleKeydown 內，
                // 且主要依賴 blur 事件來處理，我們主要依靠 blur 來完成任務。
            };

            // 處理失焦 (Blur) 事件 - 當點擊其他地方或按 Tab
            const handleBlur = () => {
                // 移除事件監聽器以防止重複觸發
                input.removeEventListener('blur', handleBlur);
                input.removeEventListener('keydown', handleKeydown);

                const newQuantity = parseInt(input.value, 10);
                
                // 檢查是否為有效數字且數量有變動
                if (!isNaN(newQuantity) && newQuantity >= 0 && newQuantity !== currentQuantity) {
                    updateInventory(parseInt(element.dataset.row, 10), newQuantity);
                    // 由於 updateInventory 是異步的，我們暫時保留舊值，等待 API 回應後再由 updateInventory 內部更新 DOM
                } else {
                    // 恢復為文字顯示模式（使用舊值，因為沒有提交）
                    exitEditMode(element, currentQuantity);
                }
            };

            // 處理 Enter 鍵事件 - 快速提交
            const handleKeydown = (e) => {
                if (e.key === 'Enter') {
                    input.blur(); // 觸發 blur 事件
                }
            };

            // 清空舊內容並插入輸入框
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
            
            input.addEventListener('blur', handleBlur);
            input.addEventListener('keydown', handleKeydown);

            // 當點擊輸入框外部時，退出編輯模式（這個外部監聽器邏輯保留以應對複雜的點擊情況）
            document.addEventListener('click', function globalClick(e) {
                if (!element.contains(e.target)) {
                    // 使用 setTimeout 確保 blur 優先處理
                    setTimeout(() => {
                        if (element.querySelector('input')) {
                            // 如果輸入框還存在，強制執行 blur
                            input.blur();
                        }
                        document.removeEventListener('click', globalClick); // 完成後移除自身
                    }, 50);
                }
            });
        }


        /**
         * 發送 POST 請求更新庫存到 Apps Script
         * @param {number} row - 要更新的試算表行號
         * @param {number} newQuantity - 新的庫存數量
         */
        async function updateInventory(row, newQuantity) {
            const container = document.getElementById(`item-${row}`);
            const statusElement = document.getElementById(`status-${row}`);
            const quantitySpan = container.querySelector(`.editable-quantity`);
            
            if (!quantitySpan) return; // 安全檢查

            // 鎖定 UI，顯示處理中
            statusElement.textContent = '更新中...';
            statusElement.className = 'text-blue-600 text-sm mt-3 h-4';
            container.style.opacity = 0.6;

            const postBody = {
                sheetName: currentSheet,
                row: row,
                newQuantity: newQuantity
            };

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postBody)
                });

                const result = await response.json();

                if (result.error) {
                    throw new Error(result.message);
                }

                // 成功更新後，更新前端的顯示和 data 屬性，確保下一次點擊能讀取到新值
                quantitySpan.innerHTML = newQuantity;
                quantitySpan.dataset.quantity = newQuantity; // 關鍵：更新 data 屬性
                
                displayItemStatus(row, '✅ 更新成功', true);

            } catch (error) {
                console.error('更新失敗:', error);
                displayItemStatus(row, `❌ 更新失敗: ${error.message.substring(0, 30)}...`, false);
                // 失敗時，強制重新載入以同步資料
                loadInventory(currentSheet); 
            } finally {
                container.style.opacity = 1;
            }
        }

    </script>
</body>
</html>
